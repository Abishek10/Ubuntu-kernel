From 657427a497a5fd912251740ec4ee9c3b3bad0f49 Mon Sep 17 00:00:00 2001
From: Tomas Winkler <tomas.winkler@intel.com>
Date: Sat, 30 Jun 2007 09:41:59 +0800
Subject: [PATCH] mac80211: [HT] IEEE 802.11n RX aggregation debugfs support

IEEE 802.11n RX aggregation debugfs support

Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
Signed-off-by: Zhu Yi <yi.zhu@intel.com>
---
 net/mac80211/debugfs_sta.c |   62 +++++++++++++++++++++++++++++++------------
 1 files changed, 44 insertions(+), 18 deletions(-)

diff --git a/net/mac80211/debugfs_sta.c b/net/mac80211/debugfs_sta.c
index dbcbfe5..6da8519 100644
--- a/net/mac80211/debugfs_sta.c
+++ b/net/mac80211/debugfs_sta.c
@@ -204,16 +204,26 @@ STA_OPS(wme_tx_queue);
 static ssize_t sta_agg_status_read(struct file *file, char __user *userbuf,
                                    size_t count, loff_t *ppos)
 {
-        char buf[512], *p = buf;
+        char buf[768], *p = buf;
         int i;
         struct sta_info *sta = file->private_data;
         p += scnprintf(p, sizeof(buf)+buf-p, "Aggregation  state for this STA is:\n");
         p += scnprintf(p, sizeof(buf)+buf-p, " STA next dialog_token is %d \n TIDs info is: \n TID :",
-                (sta->ht_ba_mlme.dialog_token + 1));
+                (sta->ht_ba_mlme.dialog_token_allocator + 1));
         for (i=0;i < STA_TID_NUM;i++)
                 p += scnprintf(p, sizeof(buf)+buf-p, "%5d",i);
 
-        p += scnprintf(p, sizeof(buf)+buf-p, "\n STAT:");
+        p += scnprintf(p, sizeof(buf)+buf-p, "\n RX  :");
+        for (i=0;i < STA_TID_NUM;i++)
+                p += scnprintf(p, sizeof(buf)+buf-p, "%5d",
+                        sta->ht_ba_mlme.tid_agg_info_rx[i].state);
+
+        p += scnprintf(p, sizeof(buf)+buf-p, "\n DTKN:");
+        for (i=0;i < STA_TID_NUM;i++)
+                p += scnprintf(p, sizeof(buf)+buf-p, "%5d",
+                        sta->ht_ba_mlme.tid_agg_info_rx[i].dialog_token);
+
+        p += scnprintf(p, sizeof(buf)+buf-p, "\n TX  :");
         for (i=0;i < STA_TID_NUM;i++)
                 p += scnprintf(p, sizeof(buf)+buf-p, "%5d",
                         sta->ht_ba_mlme.tid_agg_info_tx[i].state);
@@ -232,7 +242,7 @@ static ssize_t sta_agg_status_read(struct file *file, char __user *userbuf,
 
 	return simple_read_from_buffer(userbuf, count, ppos, buf, p - buf);
 }
-// STA_OPS(agg_status);
+
 static ssize_t sta_agg_status_write(struct file *file,const char __user *user_buf, size_t count, loff_t *ppos)
 {
 	struct sta_info *sta = file->private_data;
@@ -240,7 +250,8 @@ static ssize_t sta_agg_status_write(struct file *file,const char __user *user_bu
 	struct ieee80211_local *local = wdev_priv(dev->ieee80211_ptr);
 	struct ieee80211_hw *hw = &local->hw;
 	u8 *da = sta->addr;
-	static int tid_static[16]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
+	static int tid_static_tx[16]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
+	static int tid_static_rx[16]={1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1};
 	char *endp;
 	char buf[32];
 	int buf_size,rs;
@@ -253,22 +264,37 @@ static ssize_t sta_agg_status_write(struct file *file,const char __user *user_bu
 		return -EFAULT;
 
 	tid_num = simple_strtoul(buf, &endp, 0);
-	if (endp == buf || tid_num > 15)
+	if (endp == buf)
 		return -EINVAL;
 
-	if(tid_static[tid_num] == 0) {
-		strcpy(state,"on ");
-		rs =  ieee80211_start_BA_session(hw, da, tid_num);
-		if (rs==0)
-			tid_static[tid_num] = 1;
-	} else {
-		strcpy(state,"off");
-		rs =  ieee80211_stop_BA_session(hw, da, tid_num);
-//		if (rs==0)
-			tid_static[tid_num] = 0;
+	if ((tid_num >= 100) && (tid_num <= 115)) { /* toggle Rx aggregation command */
+		tid_num = tid_num - 100;
+		if(tid_static_rx[tid_num] == 1) {
+			strcpy(state,"off ");
+			ieee80211_sta_stop_rx_BA_session(dev,da,tid_num,0,WLAN_REASON_QSTA_REQUIRE_SETUP);
+			sta->ht_ba_mlme.tid_agg_info_rx[tid_num].buf_size = 0xFF;
+			tid_static_rx[tid_num] = 0;
+		} else {
+			strcpy(state,"on ");
+			sta->ht_ba_mlme.tid_agg_info_rx[tid_num].buf_size = 0x00;
+			tid_static_rx[tid_num] = 1;
+		}
+		printk(KERN_ERR "sta_agg_status_write tried switching tid=%u %s\n",tid_num,state);
+	}
+	else if ((tid_num >= 0) && (tid_num <= 15)) { /* toggle Tx aggregation command */
+		if(tid_static_tx[tid_num] == 0) {
+			strcpy(state,"on ");
+			rs =  ieee80211_start_BA_session(hw, da, tid_num);
+			if (rs==0)
+				tid_static_tx[tid_num] = 1;
+		} else {
+			strcpy(state,"off");
+			rs =  ieee80211_stop_BA_session(hw, da, tid_num);
+	/*		if (rs==0) hack to enable toggeling*/
+				tid_static_tx[tid_num] = 0;
+		}
+		printk(KERN_ERR "sta_agg_status_write tried switching tid=%u %s, return=%d\n",tid_num,state,rs);
 	}
-
-	printk(KERN_ERR "sta_agg_status_write tried switching tid=%ul %s, return=%d\n",tid_num,state,rs);
 
 	return count;
 }
-- 
1.5.2

