From 915fb0b275fae6748a38ece9a67a99129fcf3cc8 Mon Sep 17 00:00:00 2001
From: Ron Rindjunsky <ron.rindjunsky@intel.com>
Date: Sat, 30 Jun 2007 07:17:59 +0800
Subject: [PATCH] mac80211: [HT] IEEE 802.11n debugfs support

This patch add debufs entry for aggregation

Signed-of-by: Ron Rindjunsky <ron.rindjunsky@intel.com>
Signed-of-by: Tomas Winkler <tomas.winkler@intel.com>
Signed-of-by: Zhu Yi <yi.zhu@intel.com>
---
 net/mac80211/debugfs_sta.c |   36 ++++++++++++++++++++++++++++++++++++
 net/mac80211/sta_info.h    |    1 +
 2 files changed, 37 insertions(+), 0 deletions(-)

diff --git a/net/mac80211/debugfs_sta.c b/net/mac80211/debugfs_sta.c
index 6cfe35a..9733fa9 100644
--- a/net/mac80211/debugfs_sta.c
+++ b/net/mac80211/debugfs_sta.c
@@ -194,6 +194,40 @@ static ssize_t sta_wme_tx_queue_read(struct file *file, char __user *userbuf,
 STA_OPS(wme_tx_queue);
 #endif
 
+static ssize_t sta_agg_status_read(struct file *file, char __user *userbuf,
+                                   size_t count, loff_t *ppos)
+{
+        char buf[512], *p = buf;
+        int i;
+        struct sta_info *sta = file->private_data;
+        p += scnprintf(p, sizeof(buf)+buf-p, "Aggregation  state for this STA is:\n");
+        p += scnprintf(p, sizeof(buf)+buf-p, " STA next dialog_token is %d \n TIDs info is: \n TID :",
+                (sta->ht_ba_mlme.dialog_token + 1));
+        for (i=0;i < STA_TID_NUM;i++)
+                p += scnprintf(p, sizeof(buf)+buf-p, "%5d",i);
+
+        p += scnprintf(p, sizeof(buf)+buf-p, "\n STAT:");
+        for (i=0;i < STA_TID_NUM;i++)
+                p += scnprintf(p, sizeof(buf)+buf-p, "%5d",
+                        sta->ht_ba_mlme.tid_agg_info_tx[i].state);
+
+        p += scnprintf(p, sizeof(buf)+buf-p, "\n DTKN:");
+        for (i=0;i < STA_TID_NUM;i++)
+                p += scnprintf(p, sizeof(buf)+buf-p, "%5d",
+                        sta->ht_ba_mlme.tid_agg_info_tx[i].dialog_token);
+
+        p += scnprintf(p, sizeof(buf)+buf-p, "\n SSEQ:");
+        for (i=0;i < STA_TID_NUM;i++)
+                p += scnprintf(p, sizeof(buf)+buf-p, "%5d",
+                        sta->ht_ba_mlme.tid_agg_info_tx[i].start_seq_num);
+
+        p += scnprintf(p, sizeof(buf)+buf-p, "\n");
+
+	return simple_read_from_buffer(userbuf, count, ppos, buf, p - buf);
+}
+STA_OPS(agg_status);
+
+
 #define DEBUGFS_ADD(name) \
 	sta->debugfs.name = debugfs_create_file(#name, 0444, \
 		sta->debugfs.dir, sta, &sta_ ##name## _ops);
@@ -227,6 +261,7 @@ void ieee80211_sta_debugfs_add(struct sta_info *sta)
 	DEBUGFS_ADD(wme_rx_queue);
 	DEBUGFS_ADD(wme_tx_queue);
 #endif
+	DEBUGFS_ADD(agg_status);
 }
 
 void ieee80211_sta_debugfs_remove(struct sta_info *sta)
@@ -241,6 +276,7 @@ void ieee80211_sta_debugfs_remove(struct sta_info *sta)
 	DEBUGFS_DEL(wme_rx_queue);
 	DEBUGFS_DEL(wme_tx_queue);
 #endif
+	DEBUGFS_DEL(agg_status);
 
 	debugfs_remove(sta->debugfs.dir);
 	sta->debugfs.dir = NULL;
diff --git a/net/mac80211/sta_info.h b/net/mac80211/sta_info.h
index 9dbada8..881692a 100644
--- a/net/mac80211/sta_info.h
+++ b/net/mac80211/sta_info.h
@@ -161,6 +161,7 @@ struct sta_info {
 		struct dentry *last_ack_ms;
 		struct dentry *inactive_ms;
 		struct dentry *last_seq_ctrl;
+		struct dentry *agg_status;
 #ifdef CONFIG_MAC80211_DEBUG_COUNTERS
 		struct dentry *wme_rx_queue;
 		struct dentry *wme_tx_queue;
-- 
1.5.2

