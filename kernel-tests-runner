#!/bin/sh

# kernel-tests-runner
#
# The master, control script for running the tests the Ubuntu kernel
# team wants QA to run as part of their regression tests.
#

CDIR="`dirname $0`"

# Call python script - which does:
#    Read test (and collections) names from env KERNEL_TEST_LIST
#    Expand any test collections
#    Make tests to see which control files should be run
#    Create a batch file containing setup
#    Create a batch file setting environment variables for tests to run
./$CDIR/kernel-test-expander

# run presetup, which was created by kernel-test-expander
. ./presetup

# WORKSPACE may be passed in from the top-level jenkins job
if [ -z "$WORKSPACE" ]; then
    WORKSPACE=/tmp/workspace
    mkdir -p $WORKSPACE
fi

echo ">>>  test-attributes begin"
./$CDIR/gather-attributes $VIRTUAL_HOST_NAME | tee test-attributes.json
echo ">>>  test-attributes end"

set +e # We want _all_ the tests to run even if one of them errors out.

for TEST in $TESTS_CONTROL; do
    TEST_NAME=$TEST AGGREGATE_RESULTS=true AGGREGATE_RESULTS_DIR=$WORKSPACE $CDIR/job-autotest -c control $TEST
done

# run run-tests, which was created by kernel-test-expander
. ./run-tests

# process metrics, etc
. $CDIR/job-postprocessing

for TEST in $TEST_INFO; do
    TESTNAME
    TEST_NAME=$TEST AGGREGATE_RESULTS=true AGGREGATE_RESULTS_DIR=$WORKSPACE $CDIR/job-autotest -c control.ubuntu $TEST
done

# Stitch all the individual test results files together.
#
autotest/client/tools/glue_testsuites $WORKSPACE/*.xml > $WORKSPACE/kernel-results.xml

# vi:set ts=4 sw=4 expandtab:
