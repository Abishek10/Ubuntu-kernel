#!/bin/sh

# kernel-tests-runner
#
# The master, control script for running the tests the Ubuntu kernel
# team wants QA to run as part of their regression tests.
#

CDIR="`dirname $0`"

# All the tests that use the standard "control" file.
#
if [ -z "$TESTS_CONTROL" ]; then
    TESTS_CONTROL=" "
    TESTS_CONTROL="$TESTS_CONTROL qrt"
    TESTS_CONTROL="$TESTS_CONTROL ecryptfs"
    TESTS_CONTROL="$TESTS_CONTROL stress"
fi

if [ -z "$WORKSPACE" ]; then
    WORKSPACE=/tmp/workspace
    mkdir -p $WORKSPACE
fi

echo ">>>  test-attributes begin"
./$CDIR/gather-attributes | tee test-attributes.json
echo ">>>  test-attributes end"

set +e # We want _all_ the tests to run even if one of them errors out.
for TEST in $TESTS_CONTROL; do
    TEST_NAME=$TEST AGGREGATE_RESULTS=true AGGREGATE_RESULTS_DIR=$WORKSPACE $CDIR/job-autotest -c control $TEST
done


# All the tests that use the non-standard "control.ubuntu" file.
#
if [ -z "$TESTS_CONTROL_UBUNTU" ]; then
    TESTS_CONTROL_UBUNTU=" "
#    TESTS_CONTROL_UBUNTU="$TESTS_CONTROL_UBUNTU xfstests"
fi

set +e # We want _all_ the tests to run even if one of them errors out.
for TEST in $TESTS_CONTROL_UBUNTU; do
    TEST_NAME=$TEST AGGREGATE_RESULTS=true AGGREGATE_RESULTS_DIR=$WORKSPACE $CDIR/job-autotest -c control.ubuntu $TEST
done

# Stitch all the individual test results files together.
#
autotest/client/tools/glue_testsuites $WORKSPACE/*.xml > $WORKSPACE/kernel-results.xml

# vi:set ts=4 sw=4 expandtab:
