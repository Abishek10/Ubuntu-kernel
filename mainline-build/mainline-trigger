#!/bin/bash

set -e

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

commit="$1"

master_main="$HOME/mainline"
master_tree="$master_main/build"

tags_list="$master_main/TAGS"
linus_curr="$master_main/LINUS"

cd "$master_tree" || exit 1

# Update all the remotes in this tree.
git remote | \
while read remote
do
	echo "*** $remote ..."
	git fetch "$remote"
done

# Find all the new TAGS.
git tag -l >"$tags_list.new"

diff /home/kernel-ppa/mainline/TAGS{,.new} | \
	awk '/>/ && $2 ~ /^v/ { print $2 }' >"$tags_list.added"

# Commit the list.
mv "$tags_list.new" "$tags_list"

# Run the list.
while read commit
do
	"$here/mainline-build" "$commit"
done <"$tags_list.added"

rm -f "$tags_list.added"

# Check for upstream crack of the day.
linus_tip=`git log --pretty=format:%H linus/master^..linus/master | head -1`
linus_prev=`cat "$linus_curr" 2>/dev/null || true`

echo "tip<$linus_tip>"
echo "prev<$linus_prev>"

if [ "$linus_tip" != "$linus_prev" ]; then
	# Commit the new tip.
	echo "$linus_tip" >"$linus_curr.new"
	mv -f "$linus_curr.new" "$linus_curr"

	"$here/mainline-build" --no-email "linus/master"
fi
