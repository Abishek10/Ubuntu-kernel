#!/bin/bash

set -e

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

commit="$1"

master_main="$HOME/mainline"
master_tree="$master_main/build"

master_tags="$master_main/upstream"
tags_list="$master_tags/TAGS"

cd "$master_tree" || exit 1

# Update all the remotes in this tree.
git remote | \
while read remote
do
	echo "*** $remote ..."
	git fetch "$remote"
done

# Find all the new TAGS.
git tag -l >"$tags_list.new"

diff /home/kernel-ppa/mainline/TAGS{,.new} | \
	awk '/>/ && $2 ~ /^v/ { print $2 }' | tac >"$tags_list.added"

# Commit the list.
mv "$tags_list.new" "$tags_list"

# Run the list.
while read commit
do
	"$here/cod-enqueue" "A-mainline-$commit" \
		"$here/mainline-build" "$commit"
done <"$tags_list.added"

rm -f "$tags_list.added"

while read current branch abi base
do
	curr="$master_tags/$current"
	# Check for upstream crack of the day.
	tip=`git log --pretty=format:%H $branch^..$branch | head -1`
	prev=`cat "$curr" 2>/dev/null || true`

	echo "branch<$branch> tip<$tip> prev<$prev>"

	if [ "$tip" != "$prev" ]; then
		# Commit the new tip.
		echo "$tip" >"$curr.new"
		mv -f "$curr.new" "$curr"

		"$here/cod-enqueue" "B-cod-$current" \
			"$here/mainline-build" "$branch" "$abi" "$base"
	fi
done <<EOL
LINUS		linus/master			999	daily
DRM-INTEL-NEXT	drm-intel/drm-intel-next	997	drm-intel-next
DRM-NEXT	drm-2.6/drm-next		996	drm-next
EOL
# Also allocated
# 995: sconklin -- wayland
