#!/bin/bash

set -e

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

commit="$1"

master_main="$HOME/mainline"
master_tree="$master_main/build"

tags_list="$master_main/TAGS"

cd "$master_tree"

# Update all the remotes in this tree.
git remote | \
while read remote
do
	echo "*** $remote ..."
	git fetch "$remote"
done

# Find all the new TAGS.
git tag -l >"$tags_list.new"

diff /home/kernel-ppa/mainline/TAGS{,.new} | \
	awk '/>/ && $2 ~ /^v/ { print $2 }' >"$tags_list.added"

# Commit the list.
mv "$tags_list.new" "$tags_list"

# Run the list.
while read commit
do
	"$here/mainline-build" "$commit"
done <"$tags_list.added"

rm -f "$tags_list.added"
