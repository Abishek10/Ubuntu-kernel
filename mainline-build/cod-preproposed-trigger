#!/bin/bash

set -e

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

master_main="$HOME/COD"

master_repo="/srv/kernel.ubuntu.com/git/ubuntu/"

#
# UBUNTU PRE-PROPOSED: tips of the ubuntu trees.
#
date=`date +%Y%m%d%H%M`
while read repo series branch
do
	current="${repo}_${series}_${branch}"
	curr="$master_main/preproposed/$current"
	branch="$series/$branch"

	# Add the upstream repos as needed.
	(
		cd "$master_main/$repo"
		series_repo=`echo "$repo" | sed -e "s/linux/ubuntu-$series/"`
		series_repo="$master_repo/$series_repo.git"
		if ! git remote show -n "$series" >/dev/null 2>&1; then
			echo "*** adding $series remote ($series_repo)..."
			git remote add "$series" "$series_repo"
		fi
		git fetch "$series"
	)

	tip=`cd "$master_main/$repo" && git log --pretty=format:%H $branch^..$branch | head -1`
	prev=`cat "$curr" 2>/dev/null || true`

	echo "reop<$repo> branch<$branch> tip<$tip> prev<$prev>"

	if [ "$tip" != "$prev" ]; then
		# Commit the new tip.
		echo "$tip" >"$curr.new"
		mv -f "$curr.new" "$curr"

		"$here/cod-enqueue" "A.preproposed-$current" \
			"$here/cod-preproposed" "$repo" "$series" "$tip" "$date"
	fi
done <<EOL
linux lucid master
linux-meta lucid master
linux maverick master
linux-meta maverick master
EOL
#linux-meta maverick master
