#!/usr/bin/python
#==============================================================================
# Author: Stefan Bader <stefan.bader@canonical.com>
# Copyright (C) 2010
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 3 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.
#==============================================================================
import sys, os
import optparse
from cvescripts_lib import *
import cve_lib

parser = optparse.OptionParser("Usage: %prog [options] <CVE>|<Bug#>")
dsc = "Start working on the given CVE (CVE-xxxx-yyyy) or bug (BUG-#)"
parser.add_option("-f", "--force", action="store_true", dest="force",
	default=False, help="Throw away exising work and start over!")
parser.set_description(dsc)
(opts, args) = parser.parse_args()

if len(args) != 1:
	parser.print_usage()
	sys.exit(1)

id = args[0]
if len(id) == 13 and id[0:4] == "CVE-":
	if id[8] != "-":
		raise NameError("CVE-xxxx-yyyy")
elif args[0][1:3] == "BUG-":
	print id
elif id == "security":
	pass
else:
	print "EE: " + args[0] + " must be either CVE-xxxx-yyyy or BUG-#"
	sys.exit(1)

def CreateBranch(series, package, name):
	version = GetUploadVersion(series, PkgList[series][package])
	print "  - " + package + "(" + version + ") -> " + id
	if name in GitListBranches():
		if opts.force == False:
			print "    EE: Branch " + name + " already exists"
			raise BranchExists()
		else:
			print "    WW: Trhowing away previous " + name
			os.system("git checkout -q master >/dev/null")
			os.system("git branch -D " + name + " >/dev/null")
	cmd = "git checkout -q -b " + name + " Ubuntu-" + version
	os.system(cmd)

print "II: Checking all workareas to be clean..."
if not IsWorkareaClean():
	print "EE: Refusing to start a new task while workarea is unclean"
	sys.exit(1)

#------------------------------------------------------------------------------
# Check whether there is a CVE file listed in the tracker repo.
#------------------------------------------------------------------------------
owd = os.getcwd()
if not id == "security":
	os.chdir(cvetracker_dir)
	try:
		cve = cve_lib.find_cve(id)
	except:
		print "EE: No CVE file found for {0]".format(cve)
		sys.exit(1)
	os.chdir(owd)
	AssertDir(os.path.join("workitems", os.path.basename(cve)))
	cve = os.path.join(cvetracker_dir, cve)

#------------------------------------------------------------------------------
# Try creating new branches in all workareas.
#------------------------------------------------------------------------------
for area in ListWorkareas():
	series, package = area.split(os.path.sep, 1)

	print "*", area
	try:
		os.chdir(area)
		print " - Updating repository..."
		os.system("git remote update ubuntu >/dev/null 2>&1")
		try:
			CreateBranch(series, package, id)
		except:
			print "EE: CreateBranch() failed!"
			sys.exit(1)
		else:
			os.chdir(owd)
	except:
		sys.exit(1)

if id == "security":
	if os.path.exists("current-item"):
		os.unlink("current-item")
	sys.exit(0)

#------------------------------------------------------------------------------
# FIXME: This is temporary until I get the bzr branch interaaction done
#
# Look for the CVE description file and copy it to local
#------------------------------------------------------------------------------
newcve = os.path.join("workitems", os.path.basename(cve), "tracker-data")
try:
	ofile = open(newcve, "w")
except:
	print "EE: Cannot open {0} for writing".format(newcve)
	sys.exit(1)
else:
	try:
		ifile = open(cve, "r")
	except:
		ofile.close()
		print "EE: Cannot open {0} for reading".format(cve)
		sys.exit(1)

	for line in ifile.readlines():
		ofile.write(line)
	ifile.close()
	ofile.close()
cve = newcve

#------------------------------------------------------------------------------
# Make current-item a link to the CVE file.
#------------------------------------------------------------------------------
if os.path.exists("current-item"):
	os.unlink("current-item")
os.link(cve, "current-item")

