#!/usr/bin/python
#==============================================================================
# Author: Stefan Bader <stefan.bader@canonical.com>
# Copyright (C) 2010
#
# This script is distributed under the terms and conditions of the GNU General
# Public License, Version 3 or later. See http://www.gnu.org/copyleft/gpl.html
# for details.
#==============================================================================
import sys, os, optparse
from cvescripts_lib import *
from buildenv_lib import *

parser = optparse.OptionParser("Usage: %prog [options]")
dsc    = "Switch back to work on the security release branch."
parser.set_description(dsc)
(opts, args) = parser.parse_args()

print "II: Checking all workareas to be clean..."
if not IsWorkareaClean():
	print "EE: Refusing to start a new task while workarea is unclean"
	sys.exit(1)

#------------------------------------------------------------------------------
# Try creating new branches in all workareas.
#------------------------------------------------------------------------------
owd = os.getcwd()
for area in ListWorkareas():
	series, package = area.split(os.path.sep, 1)

	if not os.path.isdir(area):
		print "EE: Working area", area, "does not exist!"
		sys.exit(1)

	os.chdir(area)
	if not "security" in GitListBranches():
		os.chdir(owd)
		continue

	print "II: Switching branches in", area
	if os.system("git checkout -q security"):
		print "EE: Branch checkout failed!"
		sys.exit(1)
	os.chdir(owd)

#------------------------------------------------------------------------------
# Remove the current workitem link
#------------------------------------------------------------------------------
if os.path.exists("current-item"):
	os.unlink("current-item")


