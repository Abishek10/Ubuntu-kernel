 include/linux/ftrace.h |    8 ++++++++
 include/linux/prctl.h  |    1 +
 kernel/sys.c           |    8 ++++++++
 kernel/trace/trace.c   |   32 ++++++++++++++++++++++++++++++++
 4 files changed, 49 insertions(+)

Index: linux-2.6.24.3-rt3/include/linux/prctl.h
===================================================================
--- linux-2.6.24.3-rt3.orig/include/linux/prctl.h	2008-02-26 23:29:35.000000000 -0500
+++ linux-2.6.24.3-rt3/include/linux/prctl.h	2008-02-26 23:30:11.000000000 -0500
@@ -3,6 +3,7 @@
 
 /* Values to pass as first argument to prctl() */
 
+#define PR_SET_TRACING    0  /* Second arg is tracing on/off */
 #define PR_SET_PDEATHSIG  1  /* Second arg is a signal */
 #define PR_GET_PDEATHSIG  2  /* Second arg is a ptr to return the signal */
 
Index: linux-2.6.24.3-rt3/kernel/sys.c
===================================================================
--- linux-2.6.24.3-rt3.orig/kernel/sys.c	2008-02-26 23:29:35.000000000 -0500
+++ linux-2.6.24.3-rt3/kernel/sys.c	2008-02-26 23:30:11.000000000 -0500
@@ -1643,6 +1643,14 @@ asmlinkage long sys_prctl(int option, un
 {
 	long error;
 
+#ifdef CONFIG_EVENT_TRACE
+	if (option == PR_SET_TRACING) {
+		if (arg2)
+			return user_trace_start();
+		return user_trace_stop();
+	}
+#endif
+
 	error = security_task_prctl(option, arg2, arg3, arg4, arg5);
 	if (error)
 		return error;
Index: linux-2.6.24.3-rt3/include/linux/ftrace.h
===================================================================
--- linux-2.6.24.3-rt3.orig/include/linux/ftrace.h	2008-02-26 23:30:00.000000000 -0500
+++ linux-2.6.24.3-rt3/include/linux/ftrace.h	2008-02-26 23:30:11.000000000 -0500
@@ -169,4 +169,12 @@ static inline void ftrace_event_task(pid
 # define ftrace_event_task(pid, prio, running)	do { } while (0)
 #endif /* CONFIG_TRACE_EVENTS */
 
+#ifdef CONFIG_TRACING
+extern void user_trace_start(void);
+extern void user_trace_stop(void);
+#else
+# define user_trace_start do { } while (0)
+# define user_trace_stop do { } while (0)
+#endif
+
 #endif /* _LINUX_FTRACE_H */
Index: linux-2.6.24.3-rt3/kernel/trace/trace.c
===================================================================
--- linux-2.6.24.3-rt3.orig/kernel/trace/trace.c	2008-02-26 23:30:01.000000000 -0500
+++ linux-2.6.24.3-rt3/kernel/trace/trace.c	2008-02-26 23:30:11.000000000 -0500
@@ -1876,6 +1876,38 @@ static struct file_operations set_tracer
 	.write = tracing_set_trace_write,
 };
 
+void notrace user_trace_start(void)
+{
+	struct trace_array *tr = &global_trace;
+
+	mutex_lock(&trace_types_lock);
+	if (tr->ctrl)
+		goto out;
+
+	tr->ctrl = 1;
+	if (current_trace && current_trace->ctrl_update)
+		current_trace->ctrl_update(tr);
+ out:
+	mutex_unlock(&trace_types_lock);
+}
+EXPORT_SYMBOL_GPL(user_trace_start);
+
+void notrace user_trace_stop(void)
+{
+	struct trace_array *tr = &global_trace;
+
+	mutex_lock(&trace_types_lock);
+	if (!tr->ctrl)
+		goto out;
+
+	tr->ctrl = 0;
+	if (current_trace && current_trace->ctrl_update)
+		current_trace->ctrl_update(tr);
+ out:
+	mutex_unlock(&trace_types_lock);
+}
+EXPORT_SYMBOL_GPL(user_trace_stop);
+
 #ifdef CONFIG_DYNAMIC_FTRACE
 
 static ssize_t
