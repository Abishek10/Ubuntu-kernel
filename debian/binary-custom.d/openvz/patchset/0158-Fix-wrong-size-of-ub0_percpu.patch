From a5a69260c66a4decfcb3d678821267a18addef67 Mon Sep 17 00:00:00 2001
From: Konstantin Khlebnikov <khlebnikov@openvz.org>
Date: Tue, 7 Oct 2008 18:22:54 +0400
Subject: [PATCH 158/158] Fix wrong size of ub0_percpu

The struct percpu_data dynamically allocated and have array only for
1 cpu, so static usage of it does not work.

Plus rework macros for static percpu variables declaration and
initialization.

http://bugzilla.openvz.org/show_bug.cgi?id=1039

Singed-off-by: Konstantin Khlebnikov <khlebnikov@openvz.org>
Signed-off-by: Pavel Emelyanov <xemul@openvz.org>
---
 include/linux/percpu.h  |   21 +++++++++++++++++----
 kernel/bc/beancounter.c |    7 ++-----
 kernel/sched.c          |    8 ++------
 kernel/ve/ve.c          |   15 ++++-----------
 4 files changed, 25 insertions(+), 26 deletions(-)

diff --git a/include/linux/percpu.h b/include/linux/percpu.h
index 37b8258..54a1d82 100644
--- a/include/linux/percpu.h
+++ b/include/linux/percpu.h
@@ -49,11 +49,20 @@ struct percpu_data {
         (__typeof__(ptr))__p->ptrs[(cpu)];	          \
 })
 
-#define static_percpu_ptr(sptr, sptrs) ({		\
+struct percpu_data_static {
+	void *ptrs[NR_CPUS];
+};
+
+#define DEFINE_PER_CPU_STATIC(type, name) \
+	static struct percpu_data_static per_cpu_data__##name; \
+	static __typeof__(type) per_cpu__##name[NR_CPUS]
+
+#define percpu_static_init(name) ({			\
 		int i;					\
 		for (i = 0; i < NR_CPUS; i++)		\
-			(sptr)->ptrs[i] = &(sptrs)[i];	\
-		(void *)__percpu_disguise(sptr);	\
+			(per_cpu_data__##name).ptrs[i] = &(per_cpu__##name)[i];\
+		(__typeof__(&(per_cpu__##name)[0]))     \
+		__percpu_disguise(&(per_cpu_data__##name));\
 	})
 
 extern void *percpu_populate(void *__pdata, size_t size, gfp_t gfp, int cpu);
@@ -67,7 +76,11 @@ extern void percpu_free(void *__pdata);
 #else /* CONFIG_SMP */
 
 #define percpu_ptr(ptr, cpu) ({ (void)(cpu); (ptr); })
-#define static_percpu_ptr(sptr, sptrs)	(&sptrs[0])
+
+#define DEFINE_PER_CPU_STATIC(type, name) \
+	static __typeof__(type) per_cpu__##name[NR_CPUS]
+
+#define percpu_static_init(name)	(&(per_cpu__##name)[0])
 
 static inline void percpu_depopulate(void *__pdata, int cpu)
 {
diff --git a/kernel/bc/beancounter.c b/kernel/bc/beancounter.c
index 00b6469..41c8335 100644
--- a/kernel/bc/beancounter.c
+++ b/kernel/bc/beancounter.c
@@ -651,10 +651,7 @@ static void init_beancounter_syslimits(struct user_beancounter *ub)
 	ub->ub_limit_rl.interval = 300*HZ;
 }
 
-#ifdef CONFIG_SMP
-static struct percpu_data ub0_percpu;
-#endif
-static struct ub_percpu_struct ub0_percpu_data[NR_CPUS];
+DEFINE_PER_CPU_STATIC(struct ub_percpu_struct, ub0_percpu);
 
 void __init ub_init_early(void)
 {
@@ -667,7 +664,7 @@ void __init ub_init_early(void)
 	init_beancounter_nolimits(ub);
 	init_beancounter_store(ub);
 	init_beancounter_struct(ub);
-	ub->ub_percpu = static_percpu_ptr(&ub0_percpu, ub0_percpu_data);
+	ub->ub_percpu = percpu_static_init(ub0_percpu);
 
 	memset(&current->task_bc, 0, sizeof(struct task_beancounter));
 	(void)set_exec_ub(ub);
diff --git a/kernel/sched.c b/kernel/sched.c
index ffc01fe..327d11a 100644
--- a/kernel/sched.c
+++ b/kernel/sched.c
@@ -385,10 +385,7 @@ static inline int cpu_of(struct rq *rq)
 #endif
 }
 
-#ifdef CONFIG_SMP
-static struct percpu_data kstat_lat_pcpu_stats;
-#endif
-static struct kstat_lat_pcpu_snap_struct kstat_lat_pcpu_stats_data[NR_CPUS];
+DEFINE_PER_CPU_STATIC(struct kstat_lat_pcpu_snap_struct, kstat_lat);
 struct kernel_stat_glob kstat_glob;
 
 DEFINE_SPINLOCK(kstat_glb_lock);
@@ -7131,8 +7128,7 @@ void __init sched_init(void)
 	int highest_cpu = 0;
 	int i, j;
 
-	kstat_glob.sched_lat.cur = static_percpu_ptr(&kstat_lat_pcpu_stats,
-			kstat_lat_pcpu_stats_data);
+	kstat_glob.sched_lat.cur = percpu_static_init(kstat_lat);
 	for_each_possible_cpu(i) {
 		struct rt_prio_array *array;
 		struct rq *rq;
diff --git a/kernel/ve/ve.c b/kernel/ve/ve.c
index e61e647..aab9734 100644
--- a/kernel/ve/ve.c
+++ b/kernel/ve/ve.c
@@ -118,13 +118,8 @@ struct ve_struct ve0 = {
 
 EXPORT_SYMBOL(ve0);
 
-#ifdef CONFIG_SMP
-static struct {
-	void *ptrs[NR_CPUS];
-} ve0_cpu_stats, ve0_lat_pcpu_stats;
-#endif
-static struct ve_cpu_stats ve0_cpu_stats_data[NR_CPUS];
-static struct kstat_lat_pcpu_snap_struct ve0_lat_pcpu_stats_data[NR_CPUS];
+DEFINE_PER_CPU_STATIC(struct ve_cpu_stats, ve0_cpu_stats);
+DEFINE_PER_CPU_STATIC(struct kstat_lat_pcpu_snap_struct, ve0_lat_stats);
 
 LIST_HEAD(ve_list_head);
 rwlock_t ve_list_lock = RW_LOCK_UNLOCKED;
@@ -147,10 +142,8 @@ void init_ve0(void)
 	(void)get_ve(ve);
 	atomic_set(&ve->pcounter, 1);
 
-	ve->cpu_stats = static_percpu_ptr(&ve0_cpu_stats,
-			ve0_cpu_stats_data);
-	ve->sched_lat_ve.cur = static_percpu_ptr(&ve0_lat_pcpu_stats,
-			ve0_lat_pcpu_stats_data);
+	ve->cpu_stats = percpu_static_init(ve0_cpu_stats);
+	ve->sched_lat_ve.cur = percpu_static_init(ve0_lat_stats);
 
 	list_add(&ve->ve_list, &ve_list_head);
 }
-- 
1.5.4.3

