From ae2649d1f4e2249b3854be0570ea5074aa1836cb Mon Sep 17 00:00:00 2001
From: Konstantin Khlebnikov <khlebnikov@openvz.org>
Date: Tue, 1 Apr 2008 18:19:20 +0400
Subject: [PATCH 57/67] Add per-VE /proc/net/tcp6

Required for netstat.
http://bugzilla.openvz.org/show_bug.cgi?id=860
---
 include/net/tcp.h   |    4 ++--
 net/ipv4/tcp_ipv4.c |   12 ++++++------
 net/ipv6/tcp_ipv6.c |   19 +++++++++++++++++--
 3 files changed, 25 insertions(+), 10 deletions(-)

diff --git a/include/net/tcp.h b/include/net/tcp.h
index bac8599..7de5423 100644
--- a/include/net/tcp.h
+++ b/include/net/tcp.h
@@ -1355,8 +1355,8 @@ struct tcp_iter_state {
 	struct seq_operations	seq_ops;
 };
 
-extern int tcp_proc_register(struct tcp_seq_afinfo *afinfo);
-extern void tcp_proc_unregister(struct tcp_seq_afinfo *afinfo);
+extern int tcp_proc_register(struct net *net, struct tcp_seq_afinfo *afinfo);
+extern void tcp_proc_unregister(struct net *net, struct tcp_seq_afinfo *afinfo);
 
 extern struct request_sock_ops tcp_request_sock_ops;
 
diff --git a/net/ipv4/tcp_ipv4.c b/net/ipv4/tcp_ipv4.c
index 54a95e9..1a83482 100644
--- a/net/ipv4/tcp_ipv4.c
+++ b/net/ipv4/tcp_ipv4.c
@@ -2289,7 +2289,7 @@ out_kfree:
 	goto out;
 }
 
-int tcp_proc_register(struct tcp_seq_afinfo *afinfo)
+int tcp_proc_register(struct net *net, struct tcp_seq_afinfo *afinfo)
 {
 	int rc = 0;
 	struct proc_dir_entry *p;
@@ -2302,7 +2302,7 @@ int tcp_proc_register(struct tcp_seq_afinfo *afinfo)
 	afinfo->seq_fops->llseek	= seq_lseek;
 	afinfo->seq_fops->release	= seq_release_private;
 
-	p = proc_net_fops_create(current->nsproxy->net_ns, afinfo->name, S_IRUGO, afinfo->seq_fops);
+	p = proc_net_fops_create(net, afinfo->name, S_IRUGO, afinfo->seq_fops);
 	if (p)
 		p->data = afinfo;
 	else
@@ -2310,12 +2310,12 @@ int tcp_proc_register(struct tcp_seq_afinfo *afinfo)
 	return rc;
 }
 
-void tcp_proc_unregister(struct tcp_seq_afinfo *afinfo)
+void tcp_proc_unregister(struct net *net, struct tcp_seq_afinfo *afinfo)
 {
 	if (!afinfo)
 		return;
 
-	proc_net_remove(current->nsproxy->net_ns, afinfo->name);
+	proc_net_remove(net, afinfo->name);
 	memset(afinfo->seq_fops, 0, sizeof(*afinfo->seq_fops));
 }
 
@@ -2456,12 +2456,12 @@ static struct tcp_seq_afinfo tcp4_seq_afinfo = {
 
 static int tcp4_proc_net_init(struct net *net)
 {
-	return tcp_proc_register(&tcp4_seq_afinfo);
+	return tcp_proc_register(net, &tcp4_seq_afinfo);
 }
 
 static void tcp4_proc_net_exit(struct net *net)
 {
-	tcp_proc_unregister(&tcp4_seq_afinfo);
+	tcp_proc_unregister(net, &tcp4_seq_afinfo);
 }
 
 static struct pernet_operations tcp4_proc_net_ops = {
diff --git a/net/ipv6/tcp_ipv6.c b/net/ipv6/tcp_ipv6.c
index d5d8c0b..d2cf1f0 100644
--- a/net/ipv6/tcp_ipv6.c
+++ b/net/ipv6/tcp_ipv6.c
@@ -2107,14 +2107,29 @@ static struct tcp_seq_afinfo tcp6_seq_afinfo = {
 	.seq_fops	= &tcp6_seq_fops,
 };
 
+static int tcp6_proc_net_init(struct net *net)
+{
+	return tcp_proc_register(net, &tcp6_seq_afinfo);
+}
+
+static void tcp6_proc_net_exit(struct net *net)
+{
+	tcp_proc_unregister(net, &tcp6_seq_afinfo);
+}
+
+static struct pernet_operations tcp6_proc_net_ops = {
+	.init = tcp6_proc_net_init,
+	.exit = tcp6_proc_net_exit,
+};
+
 int __init tcp6_proc_init(void)
 {
-	return tcp_proc_register(&tcp6_seq_afinfo);
+	return register_pernet_subsys(&tcp6_proc_net_ops);
 }
 
 void tcp6_proc_exit(void)
 {
-	tcp_proc_unregister(&tcp6_seq_afinfo);
+	unregister_pernet_subsys(&tcp6_proc_net_ops);
 }
 #endif
 
-- 
1.5.4.3

