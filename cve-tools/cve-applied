#!/bin/bash

repos="$HOME/git2"

refresh=0
case "$1" in
--refresh)	refresh=1; shift ;;
esac

if [ "$#" -lt 1 ]; then
	echo "Usage: $0 [--refresh] <sha1> ..." 1>&2
	exit 1
fi
sha1="$1"

linus_tag=`(cd "$repos/linux-linus" && git describe --contains "$sha1" 2>/dev/null)`
linus_tag=${linus_tag%%[~^][0-9]*}
release=`echo "$linus_tag" | sed -e 's/v2\.6\./2.6./'`
echo "linus master - $release" 

while read series base branch tags
do
	#[ "$branch" != "master-next" ] && continue
	(
		cd "$repos/ubuntu-$series" || exit 1
		if [ "$refresh" -eq 1 -o ! -f ".cve-$branch" ]; then
			if [ -f ".cve" ]; then
				read x common_base_old <".cve"
			else
				common_base_old=''
			fi
			common_base="$common_base_old"
			if [ "$branch" = 'master-next' ]; then
				git fetch origin
				common_base=$(git merge-base --octopus `git branch -r | grep '^  origin/' | grep -v origin/HEAD`)
				
				if [ "$common_base_old" != "$common_base" ]; then
					git log "$common_base" | \
						grep -E '\<([0-9a-f]{40}|CVE-....-....|Ubuntu-)' \
						>".cve"
				fi
			fi
			if [ -f ".cve-$branch" ]; then
				read x branch_base_old <".cve-$branch"
			else
				branch_base_old=''
			fi
			branch_base=`git log --pretty=format:%H "origin/$branch^..origin/$branch"`
			if [ "$common_base_old" != "$common_base" -o "$branch_base_old" != "$branch_base" ]; then
				git log "$common_base..origin/$branch" | \
					grep -E '\<([0-9a-f]{40}|CVE-....-....|Ubuntu-)' \
					>".cve-$branch"
			fi
		fi
		if grep -q "$sha1" ".cve-$branch" || grep -q "$sha1" ".cve"; then
			commit_release=`cat ".cve-$branch" ".cve" | perl -e '
				my $commit = "";
				my $release = "pending";
				my $result;
				my $sha1 = $ARGV[0];
				my %find = ();
				my $cnt = 0;
				my @was = ();
				for my $arg (@ARGV) {
					$find{$arg} = 1;
					$cnt++;
				}
				while (<STDIN>) {
					if (/^commit\s([a-f0-9]{40})/) {		
						$commit = $1;
					} elsif (/^\s*UBUNTU: Ubuntu-([0-9]\.\S*)/) {
						$release = $1;
					}
					if (/\b([a-f0-9]{40})\b/) {
						if (defined $find{$1}) {
							delete $find{$1};
							push(@was, $commit);
							$cnt--;
							if ($result eq "") {
								$result = $release;
							}
							if ($cnt == 0) {
								print join(",", @was) . " $result\n";
								last;
							}
						}
					}
				}
			' -- "$@"`
		fi
		read commit release <<EOM
$commit_release
EOM
		if [ "$commit" != "" -a "$tags" != "" ]; then
#			for tag in `git tag -l $tags`
#			do
#				map=`based-on "$tag"`
#				case "$map" in
#				*-$release|*-$release[\+\?])	break ;;
#				esac
#				map=''
#			done
#			if [ "$map" != "" ]; then
#				release=`echo "$map" | sed -e 's/Ubuntu-//g'`
#			fi
			first="${commit%%,*}"
			for tagp in $tags
			do
				for tag in `git tag -l "$tagp"`
				do
					map=`git describe --match $tag --contains "$first" 2>/dev/null`
					map=${map%%[~^][0-9]*}
					if [ "$map" != "" ]; then
						# We have a matching tag, extract the
						# real version from the changelog.
						# Check the commit for the changelog
						# name, else use debian.env.
						changelog=`git show --raw "$map" | awk '(/^:.*\/changelog/) { print $NF}'`
						if [ "$changelog" = "" ]; then
							debian=`git cat-file -p "$map:debian/debian.env" | sed -n -e 's/DEBIAN=//p'`
							if [ "$debian" = "" ]; then
								debian="debian"
							fi
							changelog="$debian/changelog"
						fi
						release=`git cat-file -p "$map:$changelog" | sed -n -e '1s/.*(//' -e '1s/).*//p'`

						#echo "tag:$map debian:$debian release:$release"
						break 2
					fi
				done
			done
		fi
		# Look to see the base version of linux onto which the _first_
		# version in this series was based.
		oldest_tag=`git tag -l $tags | head -1`
		linus_base=`git cat-file -p "$oldest_tag":Makefile | \
			awk '
				/^VERSION = /		{ v=$3 }
				/^PATCHLEVEL = /	{ p=$3 }
				/^SUBLEVEL = /		{ s=$3 }
				/^EXTRAVERSION = -/	{ e=$3 }
				END			{ print "v" v "." p "." s e }
			'`
		#echo "LB<$linus_base>"
		linus_date=0
		if [ "$linus_tag" != "" ]; then
			linus_date=`(cd "$repos/linux-linus" && git log --pretty=format:%ct "$linus_tag^..$linus_tag")`
		fi
		base_date=0
		if [ "$linus_base" != "" ]; then
			base_date=`(cd "$repos/linux-linus" && git log --pretty=format:%ct "$linus_base^..$linus_base")`
		fi
		#echo "LS<$linus_date> BS<$base_date>"
		if [ "$linus_date" -ne 0 -a "$linus_date" -le "$base_date" ]; then
			release='not-affected'
		fi
				
		echo "$series $branch $commit $release"
	)
done <<EOB
dapper v2.6.15 master-next Ubuntu-2.6.15-*.*
hardy v2.6.24 master-next Ubuntu-2.6.24-*.*
lucid v2.6.32 master-next Ubuntu-2.6.32-?.* Ubuntu-2.6.32-??.*
lucid v2.6.32 ec2 Ubuntu-2.6.32-3??.*
lucid v2.6.32 mvl-dove Ubuntu-2.6.32-2??.*
lucid v2.6.32 fsl-imx51 Ubuntu-2.6.31-6??.*
lucid v2.6.35 lts-backport-maverick Ubuntu-lts-2.6.35-*.*
maverick v2.6.35 master-next
maverick v2.6.35 mvl-dove Ubuntu-mvl-dove-2.6.32-4??.*
maverick v2.6.35 ti-omap4 Ubuntu-2.6.35-9??.*
natty v2.6.35 master-next Ubuntu-2.6.37-?.* Ubuntu-2.6.37-??.* Ubuntu-2.6.38-?.* Ubuntu-2.6.38-??.*
natty v2.6.35 ti-omap4 Ubuntu-2.6.38-12??.*
oneiric v2.6.38 master-next Ubuntu-2.6.39-?.* Ubuntu-2.6.39-??.*
EOB
