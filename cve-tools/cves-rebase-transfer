#!/bin/bash

config="$1"
devel="$2"
shift 2

while read series cvebranch repo branch flags tos X
do
	[ "$tos" = "-" ] && continue

	from=`echo "${series}_${cvebranch}" | sed -e "s/^${devel}_/devel_/g"`
	tos=`echo "$tos" | sed -e 's@/@ @g'`

	echo "transfer $from -> $tos" 1>&2
	grep -H "^$from:" "$@" | \
		sed -e 's/:/ /' | \
		while read file dummy state notes
		do
			case "$state" in
			released|not-affected)
				state='pending' ;;
			esac
			case "$state" in
			pending|needed)
				for to in $tos
				do
					to=`echo "$to" | sed -e 's/_/ /'`
					echo "$file $to - $state"
				done
				;;
			esac
		done
done <"$config"
