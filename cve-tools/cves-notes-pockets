#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -lt 2 ]; then
	echo "Usage: $0 <config> <devel release> <cves>" 1>&2
	exit 1
fi
config="$1"
devel="$2"
shift 2

while read series cvebranch repo branch flags X
do
	case ",$flags," in
	*,mark-pockets,*)	;;
	*)			continue ;;
	esac

	supported=1
	case ",$flags," in
	*,unsupported,*)	supported=0 ;;
	esac

	echo "$series $cvebranch (supported=$supported) ..." >&2

	versions=`"$here/cves-kernel-versions" "cve-pockets" "$series" "$cvebranch"`
	release_version="${versions%% *}"; versions="${versions#* }"
	security_version="${versions%% *}"; versions="${versions#* }"
	updates_version="${versions%% *}"; versions="${versions#* }"
	proposed_version="${versions%% *}"; versions="${versions#* }"
	ppa_version="${versions}"

	echo "$series $cvebranch (release=$release_version security=$security_version updates=$updates_version proposed=$proposed_version series=$series) ..." >&2

	search="$series"
	if [ "$series" = "$devel" ]; then
		search="devel"
	fi

	egrep -H "^${search}_${cvebranch}: *pending" "$@" |\
	while IFS=: read cve series_branch state
	do
		cve=`echo "$cve" | sed -e 's@.*/@@'`
		#echo ">$cve< >$series_branch< >$state<"

		state=`echo "$state" | sed -e 's/^ *//' -e s'/ *$//'`
		version=`echo "$state" | sed -e 's/.*(//' -e 's/)//'`
		if [ "$state" = "pending" ]; then
			note="applied"
		elif [ "$release_version" != "None" ] && \
				dpkg --compare-versions "$version" le-nl "$release_version"; then
			note="in%s-release"
		elif [ "$security_version" != "None" ] && \
				dpkg --compare-versions "$version" le-nl "$security_version"; then
			note="in%s-security"
		elif [ "$updates_version" != "None" ] && \
				dpkg --compare-versions "$version" le-nl "$updates_version"; then
			note="in%s-updates"
		elif [ "$proposed_version" != "None" ] && \
			dpkg --compare-versions "$version" le-nl "$proposed_version"; then
			note="in%s-proposed"
		elif [ "$ppa_version" != "None" ] && \
			dpkg --compare-versions "$version" le-nl "$ppa_version"; then
			note="in%sCKT%sPPA"
		else
				continue
		fi
		echo "$cve $series $cvebranch pending $note"
	done
done <"$config"
