#!/bin/bash

if [ "$#" -ne 1 ]; then
	echo "Usage: $0 <cve-tracker-file>" 1>&2
	exit 1
fi
file="$1"

cmd="sed -i '$file'"
while read series branch commit version
do
	[ "$version" = "" ] && continue
	version=`echo "$version" | sed -e 's/~.*//'`

	if [ "$version" = 'pending' ]; then
		state='needed'
	elif [ "$version" = 'not-affected' ]; then
		state='not-affected'
	else
		state="pending ($version)"
	fi

	if [ "$series" = 'oneiric' ]; then
		series='devel'
	fi

	case "$series-$branch" in
	linus-master)
		pattern="s/^\\(upstream_.*:\\) needs-triage/\\1 released ($version)/"
		;;
	dapper-master-next)
		pattern="s/^\\(${series}_linux-source-2.6.15:\\) \\(needs-triage\\|needed\\)/\\1 $state/"
		;;
	*-master-next)
		pattern="s/^\\(${series}_linux:\\) \\(needs-triage\\|needed\\)/\\1 $state/"
		;;
		
	*)	
		pattern="s/^\\(${series}_linux-$branch:\\) \\(needs-triage\\|needed\\|released\$\\)/\\1 $state/"
		;;
	esac

	cmd="$cmd -e '$pattern'"
done

#echo "$cmd"
eval "$cmd"
