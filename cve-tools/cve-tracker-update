#!/bin/bash

default_to_change="\\(active\\|needs-triage\\|needed\\|pending\\|released\\)"
case "$1" in
--rebase)
	default_to_change="\\(active\\|needs-triage\\|needed\\)"
	shift
	;;
esac

if [ "$#" -ne 1 ]; then
	echo "Usage: $0 <cve-tracker-file>" 1>&2
	exit 1
fi
file="$1"

cmd="sed -i '$file'"
while read series branch commit version
do
	[ "$version" = "" ] && continue
	#version=`echo "$version" | sed -e 's/~.*//'`

	if [ "$series" = 'precise' ]; then
		series='devel'
	fi

	to_change="$default_to_change"
	if [ "$version" = 'needs-triage' ]; then
		test_state='needs-triage'
		set_state='needs-triage'
		to_change="\\(active\\|needs-triage\\|pending\\|released\\)"
	elif [ "$version" = 'pending' ]; then
		test_state='pending'
		set_state='pending'
	elif [ "$version" = 'not-affected' ]; then
		test_state='not-affected'
		set_state='not-affected'
	elif [ "$version" = 'needed' ]; then
		test_state='needed'
		set_state='needed'
	else
		test_state="\\(released\\|not-affected\\) ($version)"
		if [ "$series" = "linus" ]; then
			set_state="released ($version)"
		elif [ "$series" = "devel" ]; then
			set_state="not-affected ($version)"
		else
			set_state="pending ($version)"
		fi
	fi

	case "$series-$branch" in
	linus-master)
		# Simply inject the upstream version.
		package_pat="\\(upstream_linux.*:\\)"
		;;
	dapper-master-next)
		package_pat="\\(${series}_linux-source-2.6.15:\\)"
		;;
	*-master-next)
		package_pat="\\(${series}_linux:\\)"
		;;
	*)	
		package_pat="\\(${series}_linux-$branch:\\)"
		;;
	esac

	# If we are released and the version is correct we want to leave the line alone
	# _otherwise_ we want to move it pending (version) so it can be detected upstream.
	cmd="$cmd -e 's/^$package_pat \\($test_state\\)$/\\1 __CORRECT__ \\2/'"
	cmd="$cmd -e 's/^$package_pat $to_change\\(.*\\)/\\1 $set_state/'"
	cmd="$cmd -e 's/^$package_pat __CORRECT__/\\1/'"
done

#echo "$cmd"
eval "$cmd"
