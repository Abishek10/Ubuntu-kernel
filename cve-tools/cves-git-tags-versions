#!/usr/bin/python3
#
# cves-git-tags
#
import sys
import re

from subprocess     import Popen, PIPE

versions = sys.argv[1:]

# Find the debian version of the release pointed to by this tag
commit_changelog = re.compile(r'^:.*\s(\S*/changelog)')
commit_version = re.compile(r'\((.*)\)')
def tag_version(tag):
    # Find the filename of the changelog
    cmd = [ 'git', 'show', '--raw', tag ]
    p = Popen(cmd, stdout=PIPE)

    changelog = None
    for line in p.stdout:
        line = line.decode('utf-8')
        match = commit_changelog.search(line)
        if match:
            changelog = match.group(1)
            break

    if not changelog:
        return tag

    # Grab the first line and pull the version string out of it
    cmd = [ 'git', 'cat-file', '-p', "%s:%s" % (tag, changelog) ]
    p = Popen(cmd, stdout=PIPE)
    line = p.stdout.readline()
    line = line.decode('utf-8')
    match = commit_version.search(line)
    if match:
        return match.group(1)

    return tag


# Get a list of tags by their debian version number
def git_taglist():
    tags = {}
    # Grab the first line and pull the version string out of it
    cmd = [ 'git', 'tag', '-l', 'Ubuntu-*' ]
    p = Popen(cmd, stdout=PIPE)
    for line in p.stdout:
        line = line.decode('utf-8')
        tag_name = line.strip()
        tag_vers = tag_version(tag_name)

        tags[tag_vers] = tag_name
    return tags


tag_version_map = git_taglist()
for version in versions:
    print(tag_version_map[version], version)
