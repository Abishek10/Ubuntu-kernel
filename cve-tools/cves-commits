#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

sha1="[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"
sha1="$sha1[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"
sha1="$sha1[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"
sha1="$sha1[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"

for cvefile in "$@"
do
	cve=`basename "$cvefile"`

	#echo "CVE: $cve" 1>&2

	commits_raw=`awk '
		BEGIN				{ chk = 0 }
		/^Patches_linux:/		{ chk = 1; next }
		/^Patches_/			{ chk = 0; next }
		(chk == 1 && /^ upstream:/)	{ print $2 }
		(chk == 1 && /^ break-fix:/ && $3 != '-')	{ print $2 ">" $3 }
	' <"$cvefile" | sed -e 's@http://git.kernel.org/[^>]*[/=]@@g'`
	if [ "$commits_raw" = "" ]; then
		continue
	fi
	commits=''
	for commit in $commits_raw
	do
		commits="$commits $commit"
	done

	echo "CVE: $cve$commits" 1>&2

	echo "$cvefile$commits"
done
