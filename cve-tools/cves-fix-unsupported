#!/bin/bash

if [ "$#" -lt 1 ]; then
	echo "Usage: $0 <devel release> <cves>" 1>&2
	exit 1
fi
devel="$1"
shift

while read series variant
do
	versions=`
	rmadison -a source "$variant" | \
	{
		while read r_variant s1 r_version s2 r_pocket s3 r_type
		do
			case "$r_pocket" in
			$series)
				release_version="$r_version"
				;;
			$series-updates)
				updates_version="$r_version"
				;;
			esac
		done
		echo "$release_version $updates_version"
	}
	`
	release_version="${versions% *}"
	updates_version="${versions#* }"

	if [ "$series" = "$devel" ]; then
		series="devel"
	fi

	egrep "^${series}_${variant}: *pending *\(" "$@" |\
	while IFS=: read cve series_branch state
	do
		#echo ">$cve< >$series_branch< >$state<"
		version=`echo "$state" | sed -e 's/.*(//' -e 's/)//'`
		if dpkg --compare-versions "$version" le-nl "$release_version"; then
			replace="not-affected"
		elif dpkg --compare-versions "$version" le-nl "$updates_version"; then
			replace="released"
		else
			continue
		fi
		sed -i "$cve" -e "s/\(^${series}_${variant}:\) *pending */\1 $replace /"
	done
done <<EOL
precise linux-armadaxp
quantal linux-armadaxp
EOL
