#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -lt 2 ]; then
	echo "Usage: $0 <config> <devel release> <cves>" 1>&2
	exit 1
fi
config="$1"
devel="$2"
shift 2

while read series cvebranch repo branch flags X
do
	supported=1
	case ",$flags," in
	*,ignored,*)		continue ;;
	*,unsupported,*)	supported=0 ;;
	esac

	echo "$series $cvebranch (supported=$supported) ..."

	versions=`"$here/cves-kernel-versions" "release-updates" "$series" "$cvebranch"`
	release_version="${versions% *}"
	updates_version="${versions#* }"

	echo "$series $cvebranch (release=$release_version updates=$updates_version series=$series) ..."

	if [ "$series" = "$devel" ]; then
		series="devel"
	fi

	egrep -H "^${series}_${cvebranch}: *pending *\(" "$@" |\
	while IFS=: read cve series_branch state
	do
		#echo ">$cve< >$series_branch< >$state<"
		version=`echo "$state" | sed -e 's/.*(//' -e 's/)//'`
		if dpkg --compare-versions "$version" le-nl "$release_version"; then
			replace="not-affected"
		elif [ "$supported" -eq 1 ]; then
			continue
		elif dpkg --compare-versions "$version" le-nl "$updates_version"; then
			replace="released"
		else
			continue
		fi
		echo "$cve $series $cvebranch $cve pending -> $replace"
		sed -i "$cve" -e "s/\(^${series}_${cvebranch}:\) *pending */\1 $replace /"
	done
done <"$config"
