#!/bin/bash

config="$1"
devel="$2"
cve_list="$3"
shift 3

while read series cvebranch repo branch flags X
do
	tos=",${flags},"
	tos="${tos#*,transfer-pending:}"
	tos="${tos%%,*}"
	tos=`echo "$tos" | sed -e 's@/@ @g'`
	[ "$tos" = "" ] && continue

	tom=",${flags},"
	tom="${tom#*,transfer-message:}"
	tom="${tom%%,*}"
	[ "$tom" = "" ] && tom="in stable"

	echo "transfer pending ${series}_${cvebranch} -> $tos" 1>&2

	grep " ${series} ${cvebranch} " "$cve_list" |
		while read file d1 d2 d3 state
		do
			file=`echo "$file" | sed -e 's@.*/@@'`
			case "$state" in
			needed|not-affected)	;;
			*)
				for to in $tos
				do
					to=`echo "$to" | sed -e 's/_/ /'`
					echo "$file $to needed $tom"
				done
				;;
			esac
		done
done <"$config"
