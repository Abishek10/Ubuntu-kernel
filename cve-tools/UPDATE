#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

out="$HOME/cve-autotriage"

cd "$out" || exit 1

wip="cve-tracker-wip"
final="cve-tracker"

echo "*** reset to kernel changes ..."
if [ ! -d "$wip" ]; then
	bzr branch lp:~canonical-kernel-team/ubuntu-cve-tracker/kernel-team/ "$wip" || exit 1
fi
if [ ! -d "$final" ]; then
	bzr branch lp:~canonical-kernel-team/ubuntu-cve-tracker/kernel-team/ "$final" || exit 1
fi

# Perform all the merges application etc in a temporary copy to avoid
# races for consumers.
(
	cd "$out/$wip" || exit 1

	bzr pull --overwrite lp:~canonical-kernel-team/ubuntu-cve-tracker/kernel-team/ || exit 1
	bzr revert

	echo "*** merging upstream changes ..."
	bzr pull lp:ubuntu-cve-tracker || bzr merge lp:ubuntu-cve-tracker
	bzr commit -m 'update from upstream'

	echo "*** scanning git repositories ..."
	mkdir -p "$out/state"
	$here/cves-sync "$out/state" $here/linux-overlay active/CVE-????-????

	echo "*** applying rebases ..."
	$here/cves-rebase-transfer active/CVE-????-???? | \
		$here/cves-tracker-update --rebase

	bzr commit -m 'autotriage'
)

# All done ... publish.
(
	cd "$out/$final" || exit 1

	bzr pull --overwrite "../$wip"
	bzr revert
)
