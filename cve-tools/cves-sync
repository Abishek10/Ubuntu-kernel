#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

repos="$HOME/cve-autotriage"

cve_list="/tmp/cve-commits.$$"

{
	overlay="$1"
	case "$overlay" in
	/*) ;;
	*)  overlay="`pwd`/$overlay" ;;
	esac
	shift

	echo "*** enumerating cve commits ..." 1>&2
	"$here/cves-commits" "$@" >"$cve_list"

	echo "*** checking linus master ..." 1>&2
	(
		cd "$repos/linux-linus" || exit 1
		git fetch origin 1>&2
		"$here/cves-applied" <"$cve_list" "$overlay" 'linus master' \
			$("$here/cves-git-tags-order" \
				`git tag -l 'v*' | grep -v v2.6.11 | \
					awk '{
						x=$1;
						sub("^v", "", x);
						gsub("-rc", "~rc", x);
						print $1 " " x
					}'
				`
			) "master" "pending"
	)

	while read series branch versions
	do
		echo "*** checking $series $branch ($versions) ... " 1>&2
		(
			cd "$repos/ubuntu-$series" || exit 1
			[ "$branch" = "master-next" ] && git fetch origin 1>&2
			tag_list=`"$here/cves-git-tags" $versions`
			"$here/cves-applied" <"$cve_list" "$overlay" \
				"$series $branch" \
				$tag_list "origin/$branch" "pending"
		)
	done <<EOB
hardy master-next 2.6.24-0
lucid master-next 2.6.32-0
lucid ec2 2.6.32-300
lucid mvl-dove 2.6.32-200
lucid fsl-imx51 2.6.31-600
lucid lts-backport-maverick 2.6.35-0
lucid lts-backport-natty 2.6.38-0
lucid lts-backport-oneiric 3.0.0-0
maverick master-next 2.6.35-0
maverick mvl-dove 2.6.32-400
maverick ti-omap4 2.6.35-900
natty master-next 2.6.37-0 2.6.38-0
natty ti-omap4 2.6.38-1200
oneiric master-next 2.6.39-0 3.0-0 3.0.0-0
oneiric ti-omap4 2.6.38-1300 3.0.0-1200
precise master-next 3.1.0-0 3.2.0-0
precise ti-omap4 3.0.0-1400 3.2.0-1400
EOB
} | "$here/cves-tracker-update"

rm -f "$cve_list"
